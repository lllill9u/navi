<%@ page language="java" contentType="text/html; charset=UTF-8"
    pageEncoding="UTF-8"%>
<%@ taglib uri="http://java.sun.com/jsp/jstl/core"  prefix="c"%>
<%@ taglib uri="http://www.springframework.org/tags/form"  prefix="form"%>
<%@ taglib uri="http://www.springframework.org/tags"  prefix="spring"%>
<%@ taglib uri="http://www.springframework.org/security/tags" prefix="security" %>
  <%-- sub 일 때 class sub 추가  , fixed-top 삭제 --%>
   <%--  sub 일 때  -> 이거사용 <header id="header" class="header sub">--%>
  
    <header id="header" class="header sub">
      <div  class="container d-flex align-items-center justify-content-lg-center position-relative " >
    
        <strong class="logo me-auto me-lg-0">
          <a href="${pageContext.request.contextPath}">
            <h1 class="sr-only">네비마인로고</h1>
          </a>
        </strong>
      
        <nav id="navbar" class="navbar order-last order-lg-0">
          <ul>
          	<c:forEach items="${main}" var="menu">
				    <li><a class="nav-link" href="${pageContext.request.contextPath}${menu.rescUrl}">${menu.rescMenu}</a></li>
            <%--  <li><a class="nav-link" href="${pageContext.request.contextPath}/project">프로젝트</a></li> --%>
			      </c:forEach>
            
          </ul>

         <%-- 알림 --%>
          <ul class="right_util d-flex">
            <li class="dropdown alarm">
              <a href="#">
                <span class="icon alarm"
                  ><span class="sr-only">알림</span><em class="num" id="alramListCnt"></em></span></a>
              <ul class="alarmlist">
              </ul>
            </li>
            <%-- 알림 --%>
            <%-- 프로필,로그아웃--%>
            <li class="dropdown profil">
              <a href="#">
                <span class="icon profil">
                  <span class="sr-only">프로필사진</span>
                </span>
                ${sessionMenu}
              </a>
              <ul class="my_list">
                <li class="li">
                	<div class="li-con">
	                  <em class="d-flex align-items-center mb-2"><i class="icon sleepAlarm_b me-3"></i><span>졸음방지</span></em>
	                  <%-- checked 일때 on , checked 아닐 때 off --%>
	                  <div class="wk_con form-check form-switch">
	                   <label class="form-check-label" for="flexSwitchCheckChecked" >on/off</label>
	                    <input
	                      class="form-check-input"
	                      type="checkbox"
	                      role="switch"
	                      id="flexSwitchCheckChecked"
	                      onclick="toggleAction()"
	                    />
	                    </div>
   	                   <script>
						var testPopup;
						
						function toggleAction() {
						  var checkbox = document.getElementById("flexSwitchCheckChecked");
						  if (checkbox.checked) {
						    // Open test.jsp in a popup window
						    testPopup = window.open("${pageContext.request.contextPath}/sleepAlarm", "TestPopup", "width=600,height=400");
						  } else {
						    // Close the popup window
						    if (testPopup) {
						      testPopup.close();
						    }
						  }
						}
						</script>
                  </div>
                </li>
                <li class="li">
                  <a href="${pageContext.request.contextPath}/mail"  class="li-con"><i class="icon mail_b me-3"></i>메일</a>
                </li>
                 <li class="li">
                  <a href="${pageContext.request.contextPath}/myLogout" class="li-con"><i class="icon logout_b me-3"></i>로그아웃</a>
                </li>
              </ul>
            </li>
            <%--  프로필 ,로그아웃--%>
          </ul>
          <%--모바일--%>
          <i class="bi bi-list mobile-nav-toggle"></i>
          <%--모바일--%>
        </nav>
        <%-- .navbar --%>
      </div>
    </header>
<%-- End Header --%>
<script>

$(document).ready(function(){
	
	const sse = new EventSource("http://127.0.0.1/navi/connect");
	sse.addEventListener('connect', (e) => {
		const { data: receivedConnectData } = e;
		console.log('connect event data: ',receivedConnectData);  // "connected!"
	});
	sse.addEventListener('count', e => {  
	    const { data: receivedCount } = e;  
	    console.log(receivedCount);
	    let mg=receivedCount.replace(/"/g, "");
	 // 문자열을 HTML 요소로 변환
	    let tempElement = document.createElement('div');
	    tempElement.innerHTML = mg;

	    // 변환된 HTML 요소를 가져오기
	    let liTag = tempElement.firstChild;
	    let aTag = liTag.firstChild;
	    console.log("aaaaaa",$(aTag).attr("href"))
	    Push.create("알림 도착", {
	        body: $(aTag).text(),
	        icon: '/navi/resources/images/layout/navi.png',
	        timeout: 2000,
	        link:$(aTag).attr("href"),
	        onClick: function () {
	            window.focus();
	            this.close();
	        }
	    });
		$(".alarmlist")[0].innerHTML+=mg
		let cnt = parseInt(alramListCnt.innerHTML)
		if(isNaN(cnt)){
			cnt++;
			alramListCnt.innerHTML=cnt
		}
	});
	function getCsrfToken(){
	    return document.querySelector('meta[name="_csrf"]').getAttribute('content');
	 }
	 function getCsrfHeader(){
	    return document.querySelector('meta[name="_csrf_header"]').getAttribute('content');
	 }
	let context=$("body").data("contextPath")
	fetch(context+"/index.do/alram",{
		method:"GET",
		headers:{
			"Accept":"application/json"
		}
	}).then(resp=>{
		if(resp.ok){
			return resp.json();
		}else{
			throw new Error(`상태코드 ${resp.status} 수신`,{cause:resp})
		}
	}).then(jsonObj=>{
		console.log("jsonObj : ",jsonObj.length);
		if(jsonObj.length==0){
			$(".alarmlist")[0].innerHTML+=' <li><a href="#">새로운 알림이 없습니다.</a></li>'
				alramListCnt.innerHTML='0'
		}else{
			console.log(jsonObj)
			for(let al of jsonObj){
				let cn=al["altypeCn"]
				if(al["alCn"]!=null){
					cn=al["alCn"]
				}
				let alarm='<li><a class="alram-item" data-id="'+al["alarmId"]+'" href="'+context+al["alMoveUrl"]+'">'+cn+'<i class="icon new_icon"></i> </a></li>'
				$(".alarmlist")[0].innerHTML+=alarm
			}
			if(jsonObj.length>=10){
				alramListCnt.innerHTML="10+"
			}else{
				alramListCnt.innerHTML=jsonObj.length+""
			}
		}
	}).catch(err=>{
		console.error(err);
	}).finally(()=>{
		$(".alram-item").on("click",function(e){
			e.preventDefault();
			let alId=$(e.target).data("id");
			console.log(alId)
			fetch(context+"/index.do/alram?alId="+alId,{
				method:"POST",
				headers:{
					"Accept":"application/json",
					 [getCsrfHeader()]: getCsrfToken()
				}
			}).then(resp=>{
				if(resp.ok){
					return resp.json();
				}else{
					throw new Error(`상태코드 ${resp.status} 수신`,{cause:resp})
				}
			}).then(jsonObj=>{
				console.log(jsonObj)
			})
			
			let lo=$(e.target).attr("href");
			location.href=lo
		})
	})
	
})
</script>